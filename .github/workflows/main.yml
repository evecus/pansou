name: Build and Publish

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ── 1. 拉取代码 ────────────────────────────────────────────
      - name: 拉取代码
        uses: actions/checkout@v4

      # ── 2. 构建前端 ─────────────────────────────────────────────
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: 安装前端依赖
        working-directory: frontend
        run: npm ci

      - name: 构建前端
        working-directory: frontend
        run: npm run build

      # ── 3. 设置 Go ──────────────────────────────────────────────
      - name: 设置 Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: go.sum

      - name: 下载 Go 依赖
        run: go mod download

      # ── 4. 编译二进制（amd64 + arm64）──────────────────────────
      - name: 编译 linux/amd64
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -ldflags="-s -w" -o pansou-linux-amd64 .
          echo "✓ amd64 $(du -sh pansou-linux-amd64 | cut -f1)"

      - name: 编译 linux/arm64
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
          go build -ldflags="-s -w" -o pansou-linux-arm64 .
          echo "✓ arm64 $(du -sh pansou-linux-arm64 | cut -f1)"

      # ── 5. 发布二进制到 Release ─────────────────────────────────
      - name: 获取构建时间
        id: time
        run: echo "tag=build-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.time.outputs.tag }}
          name: "PanSou ${{ steps.time.outputs.tag }}"
          body: |
            ## 下载说明
            | 文件 | 适用平台 |
            |------|---------|
            | `pansou-linux-amd64` | 普通 x86_64 服务器 |
            | `pansou-linux-arm64` | ARM 架构服务器（树莓派等） |

            ## 运行
            ```bash
            chmod +x pansou-linux-amd64
            ./pansou-linux-amd64
            # 访问 http://服务器IP:5566
            ```
          files: |
            pansou-linux-amd64
            pansou-linux-arm64
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── 6. 构建并推送 Docker 多架构镜像到 DockerHub ────────────
      - name: 设置 QEMU（支持多架构）
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.d-u }}
          password: ${{ secrets.d-t }}

      - name: 构建并推送 Docker 镜像
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.d-u }}/pansou:latest
            ${{ secrets.d-t }}/pansou:${{ steps.time.outputs.tag }}
